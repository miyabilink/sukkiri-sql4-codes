definitions:
  caches:
    sql-codes: sukkiri-sql4-codes
  steps:
    - step: &japanese
        name: 'Japanese Codes(sukkiri-sql4-codes)'
        image: atlassian/default-image:2
        script:
          - git remote add sync git@github.com:miyabilink/sukkiri-sql4-codes.git
          - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
          - git fetch origin
          - git checkout main
          - git pull
          - git merge origin/main
          - git rm -f bitbucket-pipelines.yml
          - git commit -m “不要なファイル群の削除”
          - git filter-branch -f --env-filter "GIT_AUTHOR_NAME='Izumi TACHIBANA'; GIT_AUTHOR_EMAIL='tachibana@miyabilink.jp'; GIT_COMMITTER_NAME='Izumi TACHIBANA'; GIT_COMMITTER_EMAIL='tachibana@miyabilink.jp';" --tag-name-filter cat -- --all
          - git push sync --tags
          - git push -f sync main
    - step: &english
        name: 'English Codes(sukkiri-sql4-english)'
        image: atlassian/default-image:2
        script:
          - git clone git@github.com:miyabilink/sukkiri-sql4-codes.git
          - ls & cp -rf sukkiri-sql4-codes ssql4 && cd ssql4 && ls
          - git remote add sync git@github.com:miyabilink/sukkiri-sql4-english.git
          - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
          - git fetch origin
          - git checkout main
          - git pull
          - git merge origin/main
          - find . -type f -name '*.sql' -exec sed -i '' -e s/'家計簿アーカイブ'/archive/g -e s/'家計簿集計'/statistics/g -e s/'家計簿'/cashbook/g {} \;
          - find . -type f -name '*.sql' -exec sed -i '' -e s/'日付'/act_on/g -e s/'費目'/item/g -e s/'メモ'/note/g -e s/'入金額'/cash_in/g -e s/'出金額'/cash_out/g {} \;
          - git add .
          - git commit -m "convert from Japanese to English"
          - git filter-branch -f --env-filter "GIT_AUTHOR_NAME='Izumi TACHIBANA'; GIT_AUTHOR_EMAIL='tachibana@miyabilink.jp'; GIT_COMMITTER_NAME='Izumi TACHIBANA'; GIT_COMMITTER_EMAIL='tachibana@miyabilink.jp';" --tag-name-filter cat -- --all
          - git push sync --tags
          - git push -f sync main
pipelines:
    tags:
      v*.*.*:
        - step: *japanese
        - step: *english
